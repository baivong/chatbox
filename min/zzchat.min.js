/* Chatbox forumvi v0.2 by Zzbaivong (devs.forumvi.com) */
function copy_user_name(e){return $messenger[0].value+=e,$messenger.focus(),!1}function my_getcookie(e){return cname=e+"=",cpos=document.cookie.indexOf(cname),-1!=cpos?(cstart=cpos+cname.length,cend=document.cookie.indexOf(";",cstart),-1==cend&&(cend=document.cookie.length),unescape(document.cookie.substring(cstart,cend))):null}function my_setcookie(e,t,a,o){expires="",domain="",a&&(expires="; expires=Wed, 1 Jan 2020 00:00:00 GMT"),o||(o="/"),document.cookie=e+"="+t+"; path="+o+expires+domain+";"}var firstTime=!0,$wrap=$("#chatbox-wrap"),$messenger=$("#chatbox-messenger-input"),$form=$("#chatbox-form"),uId,uName,autoRefresh,$title=$("title"),regexpPM=/^(<span style="color: (#[0-9A-Fa-f]{6}|rgb\(\d{2,3}, \d{2,3}, \d{2,3}\));?">(<(strike|i|u|strong)>)*)(\d{13,}_\d+)({.*})(\["[^"]+"(\,"[^"]+")+\])(.*)$/,lastMess,userOnline=function(e){return $("#chatbox-members").find("a[onclick=\"return copy_user_name('"+e+"');\"]")},chatbox_old_update=0,zzEmoFb={all:"",emoFB:{},imgEmo:function(e,t){return'<img class="smiley_FB" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="'+e.replace(/\"/,"&quot;")+'" style="background-position:'+t+'" />'},checkEmo:function(e){return e=e.replace(zzEmoFb.all,function(e){return zzEmoFb.imgEmo(e,zzEmoFb.emoFB[e])})},list:function(e,t){$.each(zzEmoFb.emoFB,function(a,o){e.test(a)&&$(t).append(zzEmoFb.imgEmo(a,o))})},addSmiley:function(e){var t=/\bO:\)\B|\bo\.O\b|\bO\.o\b|\b8\|\B|\b8\)\B|\b3:\)\B|\B(\(y\)\B|\B:3\b|\B:\'\(\B|\B:\(\B|\B:O\b|\B:D\b|\B&gt;:\(\B|\B&lt;3\b|\B\^_\^\B|\B:\*\B|\B:v\b|\B&lt;\(\"\)\B|\B:poop:\B|\B:putnam:\B|\B\(\^\^\^\)\B|\B:\)\B|\B-_-\B|\B:P\b|\B:\/\B|\B&gt;:O\b|\B;\)\B|\B:\|\]\B)/,a=/\B:fb([0-9]|[1-9][0-9]|1[0-9][0-9]|20[0-9]):\B/;zzEmoFb.all=RegExp((t+a).replace("//","|").replace(/^\/|\/$/g,""),"g");for(var s,o=0,n=0;239>n;n++){switch(n){case 210:s="o.O";break;case 211:s="O.o";break;case 212:s=":'(";break;case 213:s="3:)";break;case 214:s=":(";break;case 215:s=":O";break;case 216:s="8)";break;case 217:s=":D";break;case 218:s="&gt;:(";break;case 219:s="&lt;3";break;case 220:s="^_^";break;case 221:s=":*";break;case 222:s=":v";break;case 223:s='&lt;(")';break;case 224:s=":poop:";break;case 225:s=":putnam:";break;case 226:s="(^^^)";break;case 227:s=":)";break;case 228:s="-_-";break;case 229:s="8|";break;case 230:s=":P";break;case 231:s=":/";break;case 232:s="&gt;:O";break;case 233:s=";)";break;case 234:s="(y)";break;case 235:s=":3";break;case 236:s=":|]";break;case 237:s="O:)";break;default:s=":fb"+n+":"}o-=17,zzEmoFb.emoFB[s]="0 "+o+"px"}var c=$("<div>",{id:"smiley_FB_frame"}).appendTo(e);zzEmoFb.list(t,"#smiley_FB_frame"),c.append('<p class="more">--- Xem thêm ---</p>');var i=$(".more",c);i.click(function(){$("p.less",c).length?i.nextAll().show():(zzEmoFb.list(a,"#smiley_FB_frame"),c.append('<p class="less">--- Thu gọn ---</p>')),$(this).hide()}),c.on("click",".less",function(){$(this).hide(),i.show().nextAll().hide()}),c.on("click","img",function(t){$messenger[0].value+=" "+this.alt,t.ctrlKey||($(e).removeClass("active"),$form.submit())}),$(e).click(function(){$(this).toggleClass("active")}),c.click(function(e){e.stopPropagation()}),$(document).click(function(t){$(t.target).closest(e).length||$(e).removeClass("active")})}};zzEmoFb.addSmiley("#chatbox-option-smiley");var regexpPM=/^(<span style="color: (#[0-9A-Fa-f]{6}|rgb\(\d{2,3}, \d{2,3}, \d{2,3}\));?">(<(strike|i|u|strong)>)*)(\d{13,}_\d+)({.*})(\["[^"]+"(\,"[^"]+")+\])(.*)$/,newMessage=function(e){if(e){var t=$.parseHTML(e);$.each(t,function(){var a=$(this),o=$(".msg",a),s=o.html();if(regexpPM.test(s)){var n=s.match(regexpPM),c=JSON.parse(n[7]),i=$.inArray(encodeURIComponent(uName),c);if(-1!==i){var r=n[5],l=$('.chatbox-content[data-id="'+r+'"]'),h=$('.chatbox-change[data-id="'+r+'"]');if(h.length)h.is(":hidden")&&-1===o.text().indexOf("]/out")&&(h.show(),userOnline(h.find("h3").text()).parent().hide());else{l=$("<div>",{"class":"chatbox-content","data-id":r,style:"display: none;"}).appendTo("#chatbox-wrap");var d,u=n[6].slice(1,-1);""===u&&(u=$.grep(c,function(e){return e!==encodeURIComponent(uName)}),1===u.length?(u=decodeURIComponent(u[0]),d=userOnline(u),d.parent().hide()):u=decodeURIComponent(u.join(", "))),h=$("<div>",{"class":"chatbox-change","data-id":r,"data-name":n[6],"data-users":n[7],html:'<h3 style="color:'+$("span",d).css("color")+'">'+u+'</h3><span class="chatbox-change-mess"></span>'}).appendTo("#chatbox-list")}o.html(zzEmoFb.checkEmo(n[1]+n[9])),a.appendTo(l)}}else a.appendTo('.chatbox-content[data-id="publish"]');var b=a.closest(".chatbox-content").attr("data-id"),m=$(".chatbox-change[data-id='"+b+"']");if(s=o.text(),"/buzz"===s)o.html('<img src="http://i.imgur.com/9GvQ6Gd.gif" width="62" height="16" />'),firstTime||"0px"===$("#chatbox-main").css("left")||(m.click(),$("#chatbox-forumvi").addClass("chatbox-buzz"),$("#chatbox-buzz-audio")[0].play(),setTimeout(function(){$("#chatbox-forumvi").removeClass("chatbox-buzz"),$messenger.focus()},1e3));else if(0===s.indexOf("/out")&&"publish"!==b)if(a.find(".user > a").text()===uName){m.add(".chatbox-content[data-id='"+b+"']").hide();var f=decodeURIComponent($.grep(m.data("users"),function(e){return e!==encodeURIComponent(uName)})[0]);userOnline(f).parent().show(),my_getcookie("chatbox_active")===b&&($(".chatbox-change[data-id='publish']").click(),my_setcookie("chatbox_active",b)),a.replaceWith('<p class="chatbox-userout me clearfix">Bạn đã rời khỏi phòng.</p>')}else a.replaceWith('<p class="chatbox-userout clearfix"><strong>'+a.find(".user > a").text()+"</strong> đã rời khỏi phòng.</p>");var p=$(".date-and-time",a),v=p.text(),x=v.match(/\[(\S+)\s(\S+)\]/);p.text("["+x[1]+"]"),a.closest(".chatbox-content").find(".chatbox-date:contains('"+x[2]+"')").length||a.before('<p class="chatbox-date clearfix">'+x[2]+"</p>")}),setTimeout(function(){var e=$('.chatbox-change[data-id="'+my_getcookie("chatbox_active")+'"]');e.length&&e.is(":visible")&&$('.chatbox-change[data-id="'+my_getcookie("chatbox_active")+'"]').click()},200);var a=JSON.parse(sessionStorage.getItem("messCounter")),o=0;if($(".chatbox-content").each(function(){var e=$(this),t=e.attr("data-id"),s=$(".chatbox_row_1, .chatbox_row_2",e).length,n=$(".chatbox-change[data-id='"+t+"']").find(".chatbox-change-mess"),c=s,i=0;a&&a[t]&&(i=parseInt(a[t],10)),c=s-i,0>=c?c="":(o+=c,c="<strong>"+c+"</strong>"),n.html(c)}),o>0){var s=$title.text(),n=/^\(\d+(\)\s.*$)/;s=n.test(s)?"("+o+s.match(n)[1]:"("+o+") "+s,$title.text(s)}setTimeout(function(){$wrap.scrollTop(99999)},300)}},lastMess,filterMess=function(e){var t,a;if(e)a=e.match(/<p class="chatbox_row_(1|2) clearfix">(?:.(?!<p class="chatbox_row_(1|2) clearfix">))*<\/p>$/)[0],void 0===lastMess?(t=e,lastMess=a,newMessage(t)):lastMess!==a&&(t=e.split(lastMess)[1],lastMess=a,newMessage(t));else{lastMess=void 0;var o={};$(".chatbox-content").each(function(){var e=$(this);o[e.attr("data-id")]=e.children("p").length}),sessionStorage.setItem("messCounter",JSON.stringify(o))}$("#chatbox-forumvi:hidden").fadeIn(200),firstTime=!1},quickAction=function(e,t,a,o){a=a?" "+a:"",$("<li>",{"class":"chatbox-action","data-action":"/"+t+a,text:o}).appendTo(e)},menuActionOne=!0,getDone=function(chatsource){return 0===chatsource.indexOf("<!DOCTYPE html PUBLIC")?(-1!==chatsource.indexOf("You have been banned from the ChatBox")?(alert("Bạn đã bị cấm truy cập chatbox!"),location.replace("/")):(alert("Mất kết nối đến máy chủ. Vui lòng đăng nhập lại!"),location.replace("/login?redirect="+location.pathname)),clearInterval(refreshFunction),!1):(eval(chatsource),$("#chatbox-members").html(chatbox_memberlist),$("a","#chatbox-members").each(function(){var e=$(this),t=e.attr("oncontextmenu").split(/\(|,|\)/);e.removeAttr("oncontextmenu");{var a=t[1],o=t[2].slice(1,-1),s=t[3],n=t[4],c=t[5],i=t[6],r=t[7];t[8],t[9]}if($(".chatbox-change > h3").each(function(){var t=$(this);return t.text()==o&&t.parent().is(":visible")?(e.parent().hide(),!1):void 0}),a===s)uId=s,uName=o,$("#chatbox-me > h2").removeClass("online away").addClass(userOnline(uName).closest("ul").prev("h4").attr("class").split(" ")[1]).html('<a href="/u'+a+'" target="_blank" style="color:'+$("span",e).css("color")+'">'+uName+"</a>"),e.parent().remove(),menuActionOne&&(quickAction("#chatbox-title ul","out",!1,"Rời khỏi phòng"),menuActionOne=!1);else{var u=$("<div>").addClass("chatbox-setting");u.insertAfter(e);var d=$("<ul>").addClass("chatbox-dropdown");d.appendTo(u),quickAction(d,"chat",o,"Trò chuyện riêng"),2==n&&(2!=i&&(quickAction(d,"kick",o,"Đuổi khỏi chatbox"),quickAction(d,"ban",o,"Cấm truy cập chat")),1==c&&2==i&&1!=r?quickAction(d,"unmod",o,"Xóa quyền quản lý"):1==c&&2!=i&&quickAction(d,"mod",o,"Thăng cấp quản lý"))}}),$(".chatbox-change > h3").each(function(){var a,e=$(this),t=userOnline(e.text()).closest("ul").prev("h4");t.hasClass("online")?a="online":t.hasClass("away")&&(a="away"),e.parent().removeClass("online away").addClass(a)}),filterMess(chatbox_messages),void 0)},disconnect=function(){clearInterval(refreshFunction),$("#chatbox-action-logout").addClass("isOut"),$(".chatbox-action-checkbox").prop("checked",!1).hide(),$messenger.val("/away"),$form.submit(),$wform.css("bottom","-90px"),setTimeout(function(){$wform.hide()},500),$wrap.css({bottom:0,opacity:.3}),$("#chatbox-tabs").css("opacity",.3)},update=function(e){$.get(e).done(function(e){getDone(e)}).fail(function(t){0===t.responseText.indexOf("document.getElementById('refresh_auto')")&&$("#chatbox-input-autologin").prop("checked")?$.post("/chatbox/chatbox_actions.forum?archives=1",{mode:"send",sent:""}).done(function(){$.get(e).done(function(e){getDone(e)})}):disconnect()})},autoUpdate=function(){refreshFunction=setInterval(function(){update("/chatbox/chatbox_actions.forum?archives=1&mode=refresh")},5e3)};update("/chatbox/chatbox_actions.forum?archives=1"),autoUpdate(),$("#chatbox-input-autorefesh").change(function(){$(this).prop("checked")?autoUpdate():clearInterval(refreshFunction)}),$("#chatbox-action-logout").click(function(){var e=$(this);e.hasClass("isOut")?($(".chatbox-action-checkbox").prop("checked",!0).show(),e.removeClass("isOut"),$wform.show(),setTimeout(function(){$wform.css("bottom",0)},10),$wrap.css({bottom:90,opacity:1}),$("#chatbox-tabs").css("opacity",1),setTimeout(function(){$wrap.scrollTop(99999)},500),autoUpdate()):disconnect()}),$messenger.on("focus click keydown",function(){var e=$messenger.attr("data-id"),t=$(".chatbox-change[data-id='"+e+"']").find(".chatbox-change-mess"),a=parseInt(t.text(),10);if(a){var o=$(".chatbox-content[data-id='"+e+"']"),s=JSON.parse(sessionStorage.getItem("messCounter"))||{};s[e]=$(".chatbox_row_1, .chatbox_row_2",$(".chatbox-content[data-id='"+e+"']")).length,sessionStorage.setItem("messCounter",JSON.stringify(s));var n=$("p",o).length-a-1,c=$("p:gt("+n+")",o);c.addClass("chatbox-newmess"),setTimeout(function(){c.removeClass("chatbox-newmess")},3e3),$title.text($title.text().replace(/\(\d+\)\s/,"")),t.empty()}}),$("#chatbox-list").on("click",".chatbox-change",function(){var e=$(this);$(".chatbox-change.active").removeClass("active"),e.addClass("active");var t=e.attr("data-id");$(".chatbox-content").hide(),$('.chatbox-content[data-id="'+t+'"]').show();var a="",o=$("#chatbox-title >.chatbox-setting");"publish"!==t?(a=t+e.attr("data-name")+e.attr("data-users"),o.show()):o.hide(),$form.attr("data-key",a),$messenger.add("#chatbox-title").attr("data-id",t),$("#chatbox-title > h2").text($("h3",e).text()),$messenger.focus(),my_setcookie("chatbox_active",t,!1),$wrap.scrollTop(99999)}),$("#chatbox-members, #chatbox-title").on("click",".chatbox-action",function(){$messenger.val($(this).attr("data-action")),$form.submit()}),$("#chatbox-hidetab").click(function(){var t,a,o,e=$(this);e.toggleClass(function(){e.hasClass("show")?(t=-270,a=0,o="hide"):(t=0,a=270,o="show"),$("#chatbox-tabs").css("left",t),$("#chatbox-main").css("left",a),my_setcookie("chatbox_tabs",o,!1)})}),"hide"===my_getcookie("chatbox_tabs")&&$("#chatbox-hidetab").click(),$("#chatbox-option-buzz").click(function(){"BUZZ"===$(this).html()&&($messenger.val("/buzz"),$form.submit())});var sendMessage=function(e){oldMessage=$messenger.val(),$.post("/chatbox/chatbox_actions.forum?archives=1",{mode:"send",sent:e,sbold:$("#chatbox-input-bold").val(),sitalic:$("#chatbox-input-italic").val(),sunderline:$("#chatbox-input-underline").val(),sstrike:$("#chatbox-input-strike").val(),scolor:$("#chatbox-input-color").val()}).done(function(){$.get("/chatbox/chatbox_actions.forum?archives=1&mode=refresh").done(function(e){getDone(e),$messenger.focus()})}).fail(function(){alert("Lỗi! Tin nhắn chưa được gửi."),$messenger.val(oldMessage)})};$form.submit(function(e){e.preventDefault();var t=$messenger.val();if(""!==$.trim(t)){var a=/^\/(chat|gift|toggle|kick|away|ban|unban|mod|unmod|cls|clear|me)(\s(.+))?$/;if(a.test(t)){var o=t.match(a),s=o[1],n=o[3],c=encodeURIComponent(n),i=encodeURIComponent(uName);if(/^(chat|gift|toggle)$/.test(s))if("chat"===s){var l=(decodeURIComponent(n),$('.chatbox-change[data-users="[\\"'+i+'\\",\\"'+c+'\\"]"]'));l.length||(l=$('.chatbox-change[data-users="[\\"'+c+'\\",\\"'+i+'\\"]"]'));var h=userOnline(n);if(l.length)l.show().click();else if(h.length){if(h.parent().hide(),!l.length){var d,u=(new Date).getTime()+"_"+uId,b=h.parent().parent().prev("h4");d=b.hasClass("online")?" online":b.hasClass("online")?" away":"",l=$("<div>",{"class":"chatbox-change"+d,"data-id":u,"data-name":"{}","data-users":'["'+i+'","'+c+'"]',html:'<h3 style="color:'+$("span",h).css("color")+'">'+n+'</h3><span class="chatbox-change-mess"></span>'}).appendTo("#chatbox-list"),l.click(),$("<div>",{"class":"chatbox-content","data-id":u,style:"display: none;"}).appendTo($wrap)}}else l.length?l.removeClass("online away").click():alert(n===uName?"Phát hiện nghi vấn Tự kỷ ^^~":"Thành viên "+n+" hiện không truy cập!")}else"toggle"===s&&$("#chatbox-hidetab").click();else sendMessage(t)}else{var m=$form.attr("data-key")+t,f=$messenger.attr("data-id");if("/buzz"==t){var p=$("#chatbox-option-buzz");if("BUZZ"===p.html()){var x,v=59;sendMessage(m),p.addClass("disable"),p.html(60),x=setInterval(function(){var e=v--;p.html(e),0>=e&&(clearInterval(x),p.removeClass("disable"),v=59,x=void 0,p.html("BUZZ"))},1e3)}}else sendMessage("/out"==t&&"publish"!==f?m:m)}$messenger.val("")}});var chooseColor=function(e){$("#chatbox-option-color").css("background",e),$("#chatbox-input-color").val(e.slice(1)),$("#chatbox-messenger").css("color",e)};$("#chatbox-option-color").click(function(){var e=function(e,t,a){return(a?arguments.callee(e,t,a-1):"#")+t[e.floor(e.random()*t.length)]}(Math,"0123456789ABCDEF",5);chooseColor(e),my_setcookie("optionColor",e,!1)});var cookieColor=my_getcookie("optionColor");cookieColor&&chooseColor(cookieColor),$("#chatbox-option-bold, #chatbox-option-italic, #chatbox-option-underline, #chatbox-option-strike").click(function(){var e=$(this);e.toggleClass(function(){var t="1";return e.hasClass("active")&&(t="0"),$("#"+this.id.replace("option","input")).val(t),"active"});var t=[],a="";$("#chatbox-form > input:not(#chatbox-input-color)").each(function(e){var s=this.value;if(t.push(s),"0"!==s)switch(e){case 0:a+="font-weight: bold;";break;case 1:a+="font-style: italic;";break;case 2:a+="text-decoration: underline;";break;case 3:a+="text-decoration: line-through;"}}),$messenger.attr("style",a),my_setcookie("optionCookie",t.join("|"),!0)});var getArrCookie=my_getcookie("optionCookie");getArrCookie&&$.each(getArrCookie.split("|"),function(e,t){"1"===t&&$("#chatbox-option > div").eq(e).click()}),$messenger.on("input",function(){var e=this.value;this.value=e.replace(/\[\/(b|i|u|strike|left|center|right|justify|size|color|font|list|quote|code|spoiler|hide|table|tr|td|flash|youtube|dailymotion|sub|sup|scroll|updown|flipv|fliph|fade|blur|wow|rand)\]|\[(\*|hr)\]/gi,"***")});