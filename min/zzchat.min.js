function copy_user_name(a){return $messenger[0].value+=a,$messenger.focus(),!1}function my_getcookie(a){return cname=a+"=",cpos=document.cookie.indexOf(cname),-1!=cpos?(cstart=cpos+cname.length,cend=document.cookie.indexOf(";",cstart),-1==cend&&(cend=document.cookie.length),unescape(document.cookie.substring(cstart,cend))):null}function my_setcookie(a,b,c,d){expires="",domain="",c&&(expires="; expires=Wed, 1 Jan 2020 00:00:00 GMT"),d||(d="/"),document.cookie=a+"="+b+"; path="+d+expires+domain+";"}var firstTime=!0,$wrap=$("#chatbox-wrap"),$messenger=$("#chatbox-messenger-input"),$form=$("#chatbox-form"),$wform=$("#chatbox-messenger-form"),uId,uName,autoRefresh,$title=$("title"),regexpPM=/^(<span style="color: (#[0-9A-Fa-f]{6}|rgb\(\d{2,3}, \d{2,3}, \d{2,3}\));?">(<(strike|i|u|strong)>)*)(\d{13,}_\d+)({.*})(\["[^"]+"(\,"[^"]+")+\])(.*)$/,lastMess,userOnline=function(a){return $("#chatbox-members").find("a[onclick=\"return copy_user_name('"+a+"');\"]")},chatbox_old_update=0,zzEmoFb={all:"",emoFB:{},imgEmo:function(a,b){return'<img class="smiley_FB" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="'+a.replace(/\"/,"&quot;")+'" style="background-position:'+b+'" />'},checkEmo:function(a){return a=a.replace(zzEmoFb.all,function(a){return zzEmoFb.imgEmo(a,zzEmoFb.emoFB[a])})},list:function(a,b){$.each(zzEmoFb.emoFB,function(c,d){a.test(c)&&$(b).append(zzEmoFb.imgEmo(c,d))})},addSmiley:function(a){var b=/\bO:\)\B|\bo\.O\b|\bO\.o\b|\b8\|\B|\b8\)\B|\b3:\)\B|\B(\(y\)\B|\B:3\b|\B:\'\(\B|\B:\(\B|\B:O\b|\B:D\b|\B&gt;:\(\B|\B&lt;3\b|\B\^_\^\B|\B:\*\B|\B:v\b|\B&lt;\(\"\)\B|\B:poop:\B|\B:putnam:\B|\B\(\^\^\^\)\B|\B:\)\B|\B-_-\B|\B:P\b|\B:\/\B|\B&gt;:O\b|\B;\)\B|\B:\|\]\B)/,c=/\B:fb([0-9]|[1-9][0-9]|1[0-9][0-9]|20[0-9]):\B/;zzEmoFb.all=RegExp((b+c).replace("//","|").replace(/^\/|\/$/g,""),"g");for(var e,d=0,f=0;239>f;f++){switch(f){case 210:e="o.O";break;case 211:e="O.o";break;case 212:e=":'(";break;case 213:e="3:)";break;case 214:e=":(";break;case 215:e=":O";break;case 216:e="8)";break;case 217:e=":D";break;case 218:e="&gt;:(";break;case 219:e="&lt;3";break;case 220:e="^_^";break;case 221:e=":*";break;case 222:e=":v";break;case 223:e='&lt;(")';break;case 224:e=":poop:";break;case 225:e=":putnam:";break;case 226:e="(^^^)";break;case 227:e=":)";break;case 228:e="-_-";break;case 229:e="8|";break;case 230:e=":P";break;case 231:e=":/";break;case 232:e="&gt;:O";break;case 233:e=";)";break;case 234:e="(y)";break;case 235:e=":3";break;case 236:e=":|]";break;case 237:e="O:)";break;default:e=":fb"+f+":"}d-=17,zzEmoFb.emoFB[e]="0 "+d+"px"}var g=$("<div>",{id:"smiley_FB_frame"}).appendTo(a);zzEmoFb.list(b,"#smiley_FB_frame"),g.append('<p class="more">--- Xem th\xeam ---</p>');var h=$(".more",g);h.click(function(){$("p.less",g).length?h.nextAll().show():(zzEmoFb.list(c,"#smiley_FB_frame"),g.append('<p class="less">--- Thu g\u1ecdn ---</p>')),$(this).hide()}),g.on("click",".less",function(){$(this).hide(),h.show().nextAll().hide()}),g.on("click","img",function(b){$messenger[0].value+=" "+this.alt,b.ctrlKey||($(a).removeClass("active"),$form.submit())}),$(a).click(function(){$(this).toggleClass("active")}),g.click(function(a){a.stopPropagation()}),$(document).click(function(b){$(b.target).closest(a).length||$(a).removeClass("active")})}};zzEmoFb.addSmiley("#chatbox-option-smiley");var regexpPM=/^(<span style="color: (#[0-9A-Fa-f]{6}|rgb\(\d{2,3}, \d{2,3}, \d{2,3}\));?">(<(strike|i|u|strong)>)*)(\d{13,}_\d+)({.*})(\["[^"]+"(\,"[^"]+")+\])(.*)$/,newMessage=function(a){if(a){var b=$.parseHTML(a);$.each(b,function(){var c=$(this),d=$(".msg",c),e=d.html();if(regexpPM.test(e)){var f=e.match(regexpPM),g=JSON.parse(f[7]),h=$.inArray(encodeURIComponent(uName),g);if(-1!==h){var i=f[5],j=$('.chatbox-content[data-id="'+i+'"]'),k=$('.chatbox-change[data-id="'+i+'"]');if(k.length)k.is(":hidden")&&-1===d.text().indexOf("]/out")&&(k.show(),userOnline(k.find("h3").text()).parent().hide());else{j=$("<div>",{"class":"chatbox-content","data-id":i,style:"display: none;"}).appendTo("#chatbox-wrap");var m,l=f[6].slice(1,-1);""===l&&(l=$.grep(g,function(a){return a!==encodeURIComponent(uName)}),1===l.length?(l=decodeURIComponent(l[0]),m=userOnline(l),m.parent().hide()):l=decodeURIComponent(l.join(", "))),k=$("<div>",{"class":"chatbox-change","data-id":i,"data-name":f[6],"data-users":f[7],html:'<h3 style="color:'+$("span",m).css("color")+'">'+l+'</h3><span class="chatbox-change-mess"></span>'}).appendTo("#chatbox-list")}d.html(zzEmoFb.checkEmo(f[1]+f[9])),c.appendTo(j)}}else d.html(zzEmoFb.checkEmo(d.html())),c.appendTo('.chatbox-content[data-id="publish"]');var n=c.closest(".chatbox-content").attr("data-id"),o=$(".chatbox-change[data-id='"+n+"']");if(e=d.text(),"/buzz"===e)d.html('<img src="http://i.imgur.com/9GvQ6Gd.gif" width="62" height="16" />'),firstTime||"-1px"===$("#chatbox-main").css("left")||(o.click(),$("#chatbox-forumvi").addClass("chatbox-buzz"),$("#chatbox-buzz-audio")[0].play(),setTimeout(function(){$("#chatbox-forumvi").removeClass("chatbox-buzz"),$messenger.focus()},1e3));else if(0===e.indexOf("/out")&&"publish"!==n)if(c.find(".user > a").text()===uName){o.add(".chatbox-content[data-id='"+n+"']").hide();var p=decodeURIComponent($.grep(o.data("users"),function(a){return a!==encodeURIComponent(uName)})[0]);userOnline(p).parent().show(),my_getcookie("chatbox_active")===n&&($(".chatbox-change[data-id='publish']").click(),my_setcookie("chatbox_active",n)),c.replaceWith('<p class="chatbox-userout me clearfix">B\u1ea1n \u0111\xe3 r\u1eddi kh\u1ecfi ph\xf2ng.</p>')}else c.replaceWith('<p class="chatbox-userout clearfix"><strong>'+c.find(".user > a").text()+"</strong> \u0111\xe3 r\u1eddi kh\u1ecfi ph\xf2ng.</p>");var q=$(".date-and-time",c),r=q.text(),s=r.match(/\[(\S+)\s(\S+)\]/);q.text("["+s[1]+"]"),c.closest(".chatbox-content").find(".chatbox-date:contains('"+s[2]+"')").length||c.before('<p class="chatbox-date clearfix">'+s[2]+"</p>")}),setTimeout(function(){var a=$('.chatbox-change[data-id="'+my_getcookie("chatbox_active")+'"]');a.length&&a.is(":visible")&&$('.chatbox-change[data-id="'+my_getcookie("chatbox_active")+'"]').click()},200);var c=JSON.parse(sessionStorage.getItem("messCounter")),d=0;if($(".chatbox-content").each(function(){var a=$(this),b=a.attr("data-id"),e=$(".chatbox_row_1, .chatbox_row_2",a).length,f=$(".chatbox-change[data-id='"+b+"']").find(".chatbox-change-mess"),g=e,h=0;c&&c[b]&&(h=parseInt(c[b],10)),g=e-h,0>=g?g="":(d+=g,g="<strong>"+g+"</strong>"),f.html(g)}),d>0){var e=$title.text(),f=/^\(\d+(\)\s.*$)/;e=f.test(e)?"("+d+e.match(f)[1]:"("+d+") "+e,$title.text(e)}setTimeout(function(){$wrap.scrollTop(99999)},300)}},lastMess,filterMess=function(a){var b,c;if(a)c=a.match(/<p class="chatbox_row_(1|2) clearfix">(?:.(?!<p class="chatbox_row_(1|2) clearfix">))*<\/p>$/)[0],void 0===lastMess?(b=a,lastMess=c,newMessage(b)):lastMess!==c&&(b=a.split(lastMess)[1],lastMess=c,newMessage(b));else{lastMess=void 0;var d={};$(".chatbox-content").each(function(){var a=$(this);d[a.attr("data-id")]=a.children("p").length}),sessionStorage.setItem("messCounter",JSON.stringify(d))}$("#chatbox-forumvi:hidden").fadeIn(200),firstTime=!1},quickAction=function(a,b,c,d){c=c?" "+c:"",$("<li>",{"class":"chatbox-action","data-action":"/"+b+c,text:d}).appendTo(a)},menuActionOne=!0,getDone=function(chatsource){return 0===chatsource.indexOf("<!DOCTYPE html PUBLIC")?(-1!==chatsource.indexOf("You have been banned from the ChatBox")?console.log("B\u1ea1n \u0111\xe3 b\u1ecb c\u1ea5m truy c\u1eadp chatbox!"):console.log("M\u1ea5t k\u1ebft n\u1ed1i \u0111\u1ebfn m\xe1y ch\u1ee7. Vui l\xf2ng \u0111\u0103ng nh\u1eadp l\u1ea1i!"),clearInterval(refreshFunction),!1):(eval(chatsource),$("#chatbox-members").html(chatbox_memberlist),$("a","#chatbox-members").each(function(){var a=$(this),b=a.attr("oncontextmenu").split(/\(|,|\)/);a.removeAttr("oncontextmenu");var c=b[1],d=b[2].slice(1,-1),e=b[3],f=b[4],g=b[5],h=b[6],i=b[7];if(b[8],b[9],$(".chatbox-change > h3").each(function(){var b=$(this);return b.text()==d&&b.parent().is(":visible")?(a.parent().hide(),!1):void 0}),c===e)uId=e,uName=d,$("#chatbox-me > h2").removeClass("online away").addClass(userOnline(uName).closest("ul").prev("h4").attr("class").split(" ")[1]).html('<a href="/u'+c+'" target="_blank" style="color:'+$("span",a).css("color")+'">'+uName+"</a>"),a.parent().remove(),menuActionOne&&(quickAction("#chatbox-title ul","out",!1,"R\u1eddi kh\u1ecfi ph\xf2ng"),menuActionOne=!1);else{var l=$("<div>").addClass("chatbox-setting");l.insertAfter(a);var m=$("<ul>").addClass("chatbox-dropdown");m.appendTo(l),quickAction(m,"chat",d,"Tr\xf2 chuy\u1ec7n ri\xeang"),2==f&&(2!=h&&(quickAction(m,"kick",d,"\u0110u\u1ed5i kh\u1ecfi chatbox"),quickAction(m,"ban",d,"C\u1ea5m truy c\u1eadp chat")),1==g&&2==h&&1!=i?quickAction(m,"unmod",d,"X\xf3a quy\u1ec1n qu\u1ea3n l\xfd"):1==g&&2!=h&&quickAction(m,"mod",d,"Th\u0103ng c\u1ea5p qu\u1ea3n l\xfd"))}}),$(".chatbox-change > h3").each(function(){var c,a=$(this),b=userOnline(a.text()).closest("ul").prev("h4");b.hasClass("online")?c="online":b.hasClass("away")&&(c="away"),a.parent().removeClass("online away").addClass(c)}),filterMess(chatbox_messages),void 0)},disconnect=function(){clearInterval(refreshFunction),$("#chatbox-action-logout").addClass("isOut"),$(".chatbox-action-checkbox").prop("checked",!1).hide(),$messenger.val("/away"),$form.submit(),$wform.css("bottom","-90px"),setTimeout(function(){$wform.hide()},500),$wrap.css({bottom:0,opacity:.3}),$("#chatbox-tabs").css("opacity",.3)},update=function(a){$.get(a).done(function(a){getDone(a)}).fail(function(b){0===b.responseText.indexOf("document.getElementById('refresh_auto')")&&$("#chatbox-input-autologin").prop("checked")?$.post("/chatbox/chatbox_actions.forum?archives=1",{mode:"send",sent:""}).done(function(){$.get(a).done(function(a){getDone(a)})}):disconnect()})},autoUpdate=function(){refreshFunction=setInterval(function(){update("/chatbox/chatbox_actions.forum?archives=1&mode=refresh")},5e3)};update("/chatbox/chatbox_actions.forum?archives=1"),autoUpdate(),$("#chatbox-input-autorefesh").change(function(){$(this).prop("checked")?autoUpdate():clearInterval(refreshFunction)}),$("#chatbox-action-logout").click(function(){var a=$(this);a.hasClass("isOut")?($(".chatbox-action-checkbox").prop("checked",!0).show(),a.removeClass("isOut"),$wform.show(),setTimeout(function(){$wform.css("bottom",0)},10),$wrap.css({bottom:90,opacity:1}),$("#chatbox-tabs").css("opacity",1),setTimeout(function(){$wrap.scrollTop(99999)},500),autoUpdate()):disconnect()}),$messenger.on("focus click keydown",function(){var a=$messenger.attr("data-id"),b=$(".chatbox-change[data-id='"+a+"']").find(".chatbox-change-mess"),c=parseInt(b.text(),10);if(c){var d=$(".chatbox-content[data-id='"+a+"']"),e=JSON.parse(sessionStorage.getItem("messCounter"))||{};e[a]=$(".chatbox_row_1, .chatbox_row_2",$(".chatbox-content[data-id='"+a+"']")).length,sessionStorage.setItem("messCounter",JSON.stringify(e));var f=$("p",d).length-c-1,g=$("p:gt("+f+")",d);g.addClass("chatbox-newmess"),setTimeout(function(){g.removeClass("chatbox-newmess")},3e3),$title.text($title.text().replace(/\(\d+\)\s/,"")),b.empty()}}),$("#chatbox-list").on("click",".chatbox-change",function(){var a=$(this);$(".chatbox-change.active").removeClass("active"),a.addClass("active");var b=a.attr("data-id");$(".chatbox-content").hide(),$('.chatbox-content[data-id="'+b+'"]').show();var c="",d=$("#chatbox-title >.chatbox-setting");"publish"!==b?(c=b+a.attr("data-name")+a.attr("data-users"),d.show()):d.hide(),$form.attr("data-key",c),$messenger.add("#chatbox-title").attr("data-id",b),$("#chatbox-title > h2").text($("h3",a).text()),$messenger.focus(),my_setcookie("chatbox_active",b,!1),$wrap.scrollTop(99999)}),$("#chatbox-members, #chatbox-title").on("click",".chatbox-action",function(){$messenger.val($(this).attr("data-action")),$form.submit()}),$("#chatbox-hidetab").click(function(){var b,c,d,a=$(this);a.toggleClass(function(){a.hasClass("show")?(b=-271,c=-1,d="hide"):(b=0,c=270,d="show"),$("#chatbox-tabs").css("left",b),$("#chatbox-main").css("left",c),my_setcookie("chatbox_tabs",d,!1)})}),"hide"===my_getcookie("chatbox_tabs")&&$("#chatbox-hidetab").click(),$("#chatbox-option-buzz").click(function(){"BUZZ"===$(this).html()&&($messenger.val("/buzz"),$form.submit())});var sendMessage=function(a){oldMessage=$messenger.val(),$.post("/chatbox/chatbox_actions.forum?archives=1",{mode:"send",sent:a,sbold:$("#chatbox-input-bold").val(),sitalic:$("#chatbox-input-italic").val(),sunderline:$("#chatbox-input-underline").val(),sstrike:$("#chatbox-input-strike").val(),scolor:$("#chatbox-input-color").val()}).done(function(){$.get("/chatbox/chatbox_actions.forum?archives=1&mode=refresh").done(function(a){getDone(a),$messenger.focus()})}).fail(function(){console.log("L\u1ed7i! Tin nh\u1eafn ch\u01b0a \u0111\u01b0\u1ee3c g\u1eedi."),$messenger.val(oldMessage)})};$form.submit(function(a){a.preventDefault();var b=$messenger.val();if(""!==$.trim(b)){var c=/^\/(chat|gift|toggle|kick|away|ban|unban|mod|unmod|cls|clear|me)(\s(.+))?$/;if(c.test(b)){var d=b.match(c),e=d[1],f=d[3],g=encodeURIComponent(f),h=encodeURIComponent(uName);if(/^(chat|gift|toggle)$/.test(e))if("chat"===e){decodeURIComponent(f);var j=$('.chatbox-change[data-users="[\\"'+h+'\\",\\"'+g+'\\"]"]');j.length||(j=$('.chatbox-change[data-users="[\\"'+g+'\\",\\"'+h+'\\"]"]'));var k=userOnline(f);if(j.length)j.show().click();else if(k.length){if(k.parent().hide(),!j.length){var m,l=(new Date).getTime()+"_"+uId,n=k.parent().parent().prev("h4");m=n.hasClass("online")?" online":n.hasClass("online")?" away":"",j=$("<div>",{"class":"chatbox-change"+m,"data-id":l,"data-name":"{}","data-users":'["'+h+'","'+g+'"]',html:'<h3 style="color:'+$("span",k).css("color")+'">'+f+'</h3><span class="chatbox-change-mess"></span>'}).appendTo("#chatbox-list"),j.click(),$("<div>",{"class":"chatbox-content","data-id":l,style:"display: none;"}).appendTo($wrap)}}else j.length?j.removeClass("online away").click():f===uName?console.log("Ph\xe1t hi\u1ec7n nghi v\u1ea5n T\u1ef1 k\u1ef7 ^^~"):console.log("Th\xe0nh vi\xean "+f+" hi\u1ec7n kh\xf4ng truy c\u1eadp!")}else"toggle"===e&&$("#chatbox-hidetab").click();else sendMessage(b)}else{var o=$form.attr("data-key")+b,p=$messenger.attr("data-id");if("/buzz"==b){var q=$("#chatbox-option-buzz");if("BUZZ"===q.html()){var s,r=59;sendMessage(o),q.addClass("disable"),q.html(60),s=setInterval(function(){var a=r--;q.html(a),0>=a&&(clearInterval(s),q.removeClass("disable"),r=59,s=void 0,q.html("BUZZ"))},1e3)}}else"/out"==b&&"publish"!==p?sendMessage(o):sendMessage(o)}$messenger.val("")}});var chooseColor=function(a){$("#chatbox-option-color").css("background",a),$("#chatbox-input-color").val(a.slice(1)),$("#chatbox-messenger").css("color",a)};$("#chatbox-option-color").click(function(){var a=function(a,b,c){return(c?arguments.callee(a,b,c-1):"#")+b[a.floor(a.random()*b.length)]}(Math,"0123456789ABCDEF",5);chooseColor(a),my_setcookie("optionColor",a,!1)});var cookieColor=my_getcookie("optionColor");cookieColor&&chooseColor(cookieColor),$("#chatbox-option-bold, #chatbox-option-italic, #chatbox-option-underline, #chatbox-option-strike").click(function(){var a=$(this);a.toggleClass(function(){var b="1";return a.hasClass("active")&&(b="0"),$("#"+this.id.replace("option","input")).val(b),"active"});var b=[],c="";$("#chatbox-form > input:not(#chatbox-input-color)").each(function(a){var e=this.value;if(b.push(e),"0"!==e)switch(a){case 0:c+="font-weight: bold;";break;case 1:c+="font-style: italic;";break;case 2:c+="text-decoration: underline;";break;case 3:c+="text-decoration: line-through;"}}),$messenger.attr("style",c),my_setcookie("optionCookie",b.join("|"),!0)});var getArrCookie=my_getcookie("optionCookie");getArrCookie&&$.each(getArrCookie.split("|"),function(a,b){"1"===b&&$("#chatbox-option > div").eq(a).click()}),$messenger.on("input",function(){var a=this.value;this.value=a.replace(/\[\/(b|i|u|strike|left|center|right|justify|size|color|font|list|quote|code|spoiler|hide|table|tr|td|flash|youtube|dailymotion|sub|sup|scroll|updown|flipv|fliph|fade|blur|wow|rand)\]|\[(\*|hr)\]/gi,"***")});